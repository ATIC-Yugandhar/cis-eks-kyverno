apiVersion: json.kyverno.io/v1alpha1
kind: ValidatingPolicy
metadata:
  name: cis-4-1-3-minimize-wildcard-permissions
spec:
  rules:
    - name: no-wildcard-iam-policies
      assert:
        all:
          - message: "IAM policies should not use wildcard (*) permissions for actions."
            check:
              "(length(planned_values.root_module.resources[?type=='aws_iam_role_policy' && contains(values.policy, '\"Action\":\"*\"')]) == `0`)": true
          - message: "IAM policies with Resource:* should be limited to specific services like ECR that require it."
            check:
              "(length(planned_values.root_module.resources[?type=='aws_iam_role_policy' && contains(values.policy, '\"Resource\":\"*\"') && !contains(values.policy, 'ecr:')]) == `0`)": true