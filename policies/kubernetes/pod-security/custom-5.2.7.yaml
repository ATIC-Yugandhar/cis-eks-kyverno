apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: custom-5.2.7
  annotations:
    policies.kyverno.io/title: Minimize the admission of root containers
    policies.kyverno.io/category: Pod Security
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: Containers should run as non-root user to prevent privilege escalation attacks.
    policies.kyverno.io/cel: 'true'
spec:
  validationFailureAction: Enforce
  background: true
  rules:
  - name: require-run-as-non-root
    match:
      any:
      - resources:
          kinds:
          - Pod
          operations:
          - CREATE
          - UPDATE
    validate:
      message: Containers must run as non-root user.
      cel:
        expressions:
        - expression: |
            (has(object.spec.securityContext) && 
             has(object.spec.securityContext.runAsNonRoot) && 
             object.spec.securityContext.runAsNonRoot == true) ||
            object.spec.containers.all(container,
              has(container.securityContext) && 
              has(container.securityContext.runAsNonRoot) && 
              container.securityContext.runAsNonRoot == true
            )
          message: "Pod or containers must have runAsNonRoot set to true"
        - expression: |
            !has(object.spec.securityContext) || 
            !has(object.spec.securityContext.runAsUser) || 
            object.spec.securityContext.runAsUser != 0
          message: "Pod must not run as root user (UID 0)"
        - expression: |
            object.spec.containers.all(container,
              !has(container.securityContext) || 
              !has(container.securityContext.runAsUser) || 
              container.securityContext.runAsUser != 0
            )
          message: "Containers must not run as root user (UID 0)"