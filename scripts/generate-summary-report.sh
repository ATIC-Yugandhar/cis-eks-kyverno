#!/bin/bash
set -e

REPORT_DIR="reports"
SUMMARY_FILE="$REPORT_DIR/executive-summary.md"
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

cat > "$SUMMARY_FILE" << EOF
# âš™ï¸ Kyverno CIS EKS Compliance Test Report

**Generated**: $TIMESTAMP

---

## ðŸ“Š Test Results Overview

### ðŸ“‹ Policy Unit Tests
EOF

if [ -f "$REPORT_DIR/policy-tests/summary.md" ]; then
    # Extract summary statistics from Markdown file
    if grep -q "Summary Statistics" "$REPORT_DIR/policy-tests/summary.md"; then
        grep -A 6 "Summary Statistics" "$REPORT_DIR/policy-tests/summary.md" | tail -n +2 >> "$SUMMARY_FILE"
    else
        echo "- âŒ No policy test summary available" >> "$SUMMARY_FILE"
    fi
else
    echo "- âŒ No policy test results found" >> "$SUMMARY_FILE"
fi

cat >> "$SUMMARY_FILE" << EOF

### ðŸ› ï¸ Terraform Compliance Tests
EOF

if [ -f "$REPORT_DIR/terraform-compliance/compliant-plan-scan.md" ] && [ -f "$REPORT_DIR/terraform-compliance/noncompliant-plan-scan.md" ]; then
    echo "- âœ… Compliant configuration scan: **Completed**" >> "$SUMMARY_FILE"
    echo "- âœ… Non-compliant configuration scan: **Completed**" >> "$SUMMARY_FILE"
    
    # Count violations in non-compliant scan
    VIOLATIONS=$(grep -c "fail" "$REPORT_DIR/terraform-compliance/noncompliant-plan-scan.md" 2>/dev/null || echo "0")
    echo "- ðŸ”´ Policy violations detected in non-compliant config: **$VIOLATIONS**" >> "$SUMMARY_FILE"
else
    echo "- âŒ No terraform compliance results found" >> "$SUMMARY_FILE"
fi

cat >> "$SUMMARY_FILE" << EOF

---

## ðŸ“ Report Files

### ðŸ“Š Policy Tests
- **Detailed results**: [ðŸ—¾ detailed-results.md](policy-tests/detailed-results.md)
- **Summary**: [ðŸ“ˆ summary.md](policy-tests/summary.md)

### ðŸ› ï¸ Terraform Compliance
- **Compliant scan**: [âœ… compliant-plan-scan.md](terraform-compliance/compliant-plan-scan.md)
- **Non-compliant scan**: [âŒ noncompliant-plan-scan.md](terraform-compliance/noncompliant-plan-scan.md)

---

## ðŸ“Š Quick Stats

| Test Type | Status | Details |
|-----------|--------|----------|
| Policy Unit Tests | $( [ -f "$REPORT_DIR/policy-tests/summary.md" ] && echo "âœ… Complete" || echo "âŒ Missing" ) | Individual policy validation |
| Terraform Compliance | $( [ -f "$REPORT_DIR/terraform-compliance/compliant-plan-scan.md" ] && echo "âœ… Complete" || echo "âŒ Missing" ) | Infrastructure compliance |

---

*ðŸ¤– Generated by Kyverno CIS EKS Compliance Test Suite*
EOF

echo "Executive summary generated: $SUMMARY_FILE"