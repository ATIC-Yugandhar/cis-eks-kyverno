apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-5.2.1-custom-require-irsa-annotation
  annotations:
    policies.kyverno.io/title: Require IRSA Annotation on ServiceAccounts (Custom CIS 5.2.1)
    policies.kyverno.io/category: EKS Best Practices (CIS 5.2.1)
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: ServiceAccount, Annotation
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/description: >-
      ServiceAccounts should be configured with IAM Roles for Service Accounts (IRSA)
      by having the `eks.amazonaws.com/role-arn` annotation. This policy audits
      ServiceAccounts that are missing this annotation. Note: This policy audits *all*
      ServiceAccounts lacking the annotation. Consider adding specific exclusions for
      ServiceAccounts or Namespaces that do not require IRSA.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-irsa-annotation
      match:
        any:
        - resources:
            kinds:
              - ServiceAccount
      exclude:
        any:
        - resources:
            namespaces:
            - kube-system
            - kyverno
      validate:
        message: "ServiceAccount does not have the required IRSA annotation 'eks.amazonaws.com/role-arn'."
        pattern:
          metadata:
            annotations:
              eks.amazonaws.com/role-arn: "?*"