apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-5.1.6-restrict-privilege-escalation
  annotations:
    policies.kyverno.io/title: Restrict Privilege Escalation
    policies.kyverno.io/category: CIS EKS Benchmark Section 5.1
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kyverno-version: 1.7.1
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      Privilege escalation allows a container process to gain more privileges than its parent process.
      Setting `allowPrivilegeEscalation` to `false` ensures that no child process of a container can gain
      more privileges than the container's process. This is an important security measure.
      This policy requires `allowPrivilegeEscalation` to be explicitly set to `false` for all containers.
      CIS Benchmark Control: 5.1.6 Minimize the admission of containers wishing to escalate privileges
    policies.kyverno.io/cis_controls: "5.1.6"
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: check-privilege-escalation-containers
      match:
        any:
        - resources:
            kinds:
              - Pod
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Containers must not allow privilege escalation. Set securityContext.allowPrivilegeEscalation to false. CIS 5.1.6"
        pattern:
          spec:
            =(containers):
              - =(securityContext):
                  =(allowPrivilegeEscalation): false
            =(initContainers):
              - =(securityContext):
                  =(allowPrivilegeEscalation): false
            =(ephemeralContainers):
              - =(securityContext):
                  =(allowPrivilegeEscalation): false
    - name: check-privilege-escalation-controllers
      match:
        any:
        - resources:
            kinds:
              - Deployment
              - StatefulSet
              - DaemonSet
              - Job
              - CronJob
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Containers in pod templates must not allow privilege escalation. Set securityContext.allowPrivilegeEscalation to false. CIS 5.1.6"
        pattern:
          spec:
            template:
              spec:
                =(containers):
                  - =(securityContext):
                      =(allowPrivilegeEscalation): false
                =(initContainers):
                  - =(securityContext):
                      =(allowPrivilegeEscalation): false
                =(ephemeralContainers):
                  - =(securityContext):
                      =(allowPrivilegeEscalation): false