# kyverno-policies/cis/cis-4.1.2-test.yaml
name: cis-4.1.2-minimize-secret-access-test
policies:
  - cis-4.1.2.yaml
resources:
  # Pass case: Role granting access to pods, not secrets
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: pod-reader
      namespace: default
    rules:
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "list"]
  # Fail case: ClusterRole granting list access to secrets
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: secret-lister
    rules:
    - apiGroups: [""]
      resources: ["secrets"]
      verbs: ["list"] # Non-compliant verb
  # Fail case: Role granting get access to secrets
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: Role
    metadata:
      name: secret-getter
      namespace: test-ns
    rules:
    - apiGroups: [""]
      resources: ["secrets"]
      verbs: ["get"] # Non-compliant verb
results:
  - policy: cis-4.1.2-minimize-secret-access
    rule: minimize-secret-access-roles
    resource: pod-reader
    kind: Role
    result: pass
  - policy: cis-4.1.2-minimize-secret-access
    rule: minimize-secret-access-roles
    resource: secret-lister
    kind: ClusterRole
    result: fail
  - policy: cis-4.1.2-minimize-secret-access
    rule: minimize-secret-access-roles
    resource: secret-getter
    kind: Role
    result: fail