# kyverno-policies/cis/cis-4.1.5.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-4.1.5-disallow-default-serviceaccount
  annotations:
    policies.kyverno.io/title: Disallow Default ServiceAccount
    policies.kyverno.io/category: CIS EKS Benchmarks
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod,ServiceAccount
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/description: >-
      Kubernetes provides a 'default' ServiceAccount in each Namespace. Pods running without
      a specified ServiceAccount will automatically use this 'default' one. This ServiceAccount
      should not be used to ensure that Pods operate with the minimum required privileges.
      This policy validates that Pods do not use the 'default' ServiceAccount or explicitly
      disable automounting the token.
    policies.kyverno.io/benchmark: cis-eks
    policies.kyverno.io/controls: "4.1.5"
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: check-default-serviceaccount
      match:
        any:
        - resources:
            kinds:
              - Pod
      validate:
        message: "Using the default ServiceAccount is not allowed unless automountServiceAccountToken is false (CIS 4.1.5)."
        # The pod spec must satisfy one of the following conditions:
        # 1. serviceAccountName is specified and is not 'default'.
        # 2. automountServiceAccountToken is explicitly set to false.
        anyPattern:
        - spec:
            serviceAccountName: "?*" # serviceAccountName is present
            (serviceAccountName): "!default" # and not equal to 'default'
        - spec:
            automountServiceAccountToken: false # automountServiceAccountToken is false