apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-5.2.2-restrict-seccomp
  annotations:
    policies.kyverno.io/title: Restrict Seccomp Profile
    policies.kyverno.io/category: CIS EKS Benchmark Section 5.2
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kyverno-version: 1.7.1
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      Seccomp (secure computing mode) is a Linux kernel feature used to restrict the set of system calls applications can make.
      The default seccomp profile provides a reasonable default for running workloads, blocking the most common dangerous system calls.
      This policy ensures that Pods and their containers use either the 'RuntimeDefault' or 'Localhost' seccomp profile.
      CIS Benchmark Control: 5.2.2 Ensure that the seccomp profile is set to 'RuntimeDefault' or 'Localhost' in Pod definitions
    policies.kyverno.io/cis_controls: "5.2.2"
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: validate-seccomp-profile-pods
      match:
        any:
        - resources:
            kinds:
              - Pod
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Seccomp profile must be 'RuntimeDefault' or 'Localhost'. CIS 5.2.2"
        pattern:
          spec:
            =(securityContext):
              =(seccompProfile):
                type: "RuntimeDefault | Localhost"
            =(containers):
              - =(securityContext):
                  =(seccompProfile):
                    type: "RuntimeDefault | Localhost"
            =(initContainers):
              - =(securityContext):
                  =(seccompProfile):
                    type: "RuntimeDefault | Localhost"
            =(ephemeralContainers):
              - =(securityContext):
                  =(seccompProfile):
                    type: "RuntimeDefault | Localhost"
    - name: validate-seccomp-profile-controllers
      match:
        any:
        - resources:
            kinds:
              - Deployment
              - StatefulSet
              - DaemonSet
              - Job
              - CronJob
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Seccomp profile must be 'RuntimeDefault' or 'Localhost' in pod templates. CIS 5.2.2"
        pattern:
          spec:
            template:
              spec:
                =(securityContext):
                  =(seccompProfile):
                    type: "RuntimeDefault | Localhost"
                =(containers):
                  - =(securityContext):
                      =(seccompProfile):
                        type: "RuntimeDefault | Localhost"
                =(initContainers):
                  - =(securityContext):
                      =(seccompProfile):
                        type: "RuntimeDefault | Localhost"
                =(ephemeralContainers):
                  - =(securityContext):
                      =(seccompProfile):
                        type: "RuntimeDefault | Localhost"