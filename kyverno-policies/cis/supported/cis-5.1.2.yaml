apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-5.1.2-restrict-net-raw-capability
  annotations:
    policies.kyverno.io/title: Restrict NET_RAW Capability
    policies.kyverno.io/category: CIS EKS Benchmark Section 5.1
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod, Container, Capability
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kyverno-version: 1.7.1
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      The NET_RAW capability allows processes to craft raw packets, bypassing normal network stack checks.
      This capability is highly privileged and rarely required for typical applications. Its use increases
      the attack surface and potential for network-based attacks (e.g., ARP spoofing, DNS poisoning).
      This policy restricts containers from adding the NET_RAW capability.
      CIS Benchmark Control: 5.1.2 Minimize the admission of containers with the NET_RAW capability
    policies.kyverno.io/cis_controls: "5.1.2"
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: restrict-net-raw-capability-containers
      match:
        any:
        - resources:
            kinds:
              - Pod
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Adding the NET_RAW capability is not allowed. CIS 5.1.2"
        pattern:
          spec:
            =(containers):
              - =(securityContext):
                  =(capabilities):
                    =(add):
                      # Ensure NET_RAW is not in the list of added capabilities
                      X(NET_RAW)
            =(initContainers):
              - =(securityContext):
                  =(capabilities):
                    =(add):
                      X(NET_RAW)
            =(ephemeralContainers):
              - =(securityContext):
                  =(capabilities):
                    =(add):
                      X(NET_RAW)
    - name: restrict-net-raw-capability-controllers
      match:
        any:
        - resources:
            kinds:
              - Deployment
              - StatefulSet
              - DaemonSet
              - Job
              - CronJob
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Adding the NET_RAW capability is not allowed in pod templates. CIS 5.1.2"
        pattern:
          spec:
            template:
              spec:
                =(containers):
                  - =(securityContext):
                      =(capabilities):
                        =(add):
                          X(NET_RAW)
                =(initContainers):
                  - =(securityContext):
                      =(capabilities):
                        =(add):
                          X(NET_RAW)
                =(ephemeralContainers):
                  - =(securityContext):
                      =(capabilities):
                        =(add):
                          X(NET_RAW)