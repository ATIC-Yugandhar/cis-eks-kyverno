apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-5.5.1-require-resource-limits
  annotations:
    policies.kyverno.io/title: Require Container Resource Limits
    policies.kyverno.io/category: CIS EKS Benchmark Section 5.5
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod, Container, Resource Limits
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kyverno-version: 1.7.1
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      Resource limits restrict the maximum amount of CPU and memory a container can consume.
      Setting limits prevents containers from consuming excessive resources and potentially impacting
      other workloads or node stability. This policy requires all containers (including initContainers
      and ephemeralContainers) to define CPU and memory limits.
      CIS Benchmark Control: 5.5.1 Ensure that container resource limits are configured
    policies.kyverno.io/cis_controls: "5.5.1"
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-cpu-memory-limits-containers
      match:
        any:
        - resources:
            kinds:
              - Pod
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Containers must have CPU and memory limits defined. CIS 5.5.1"
        pattern:
          spec:
            =(containers):
              - resources:
                  limits:
                    cpu: "?*"
                    memory: "?*"
            =(initContainers):
              - resources:
                  limits:
                    cpu: "?*"
                    memory: "?*"
            =(ephemeralContainers):
              - resources:
                  limits:
                    cpu: "?*"
                    memory: "?*"
    - name: require-cpu-memory-limits-controllers
      match:
        any:
        - resources:
            kinds:
              - Deployment
              - StatefulSet
              - DaemonSet
              - Job
              - CronJob
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Containers in pod templates must have CPU and memory limits defined. CIS 5.5.1"
        pattern:
          spec:
            template:
              spec:
                =(containers):
                  - resources:
                      limits:
                        cpu: "?*"
                        memory: "?*"
                =(initContainers):
                  - resources:
                      limits:
                        cpu: "?*"
                        memory: "?*"
                =(ephemeralContainers):
                  - resources:
                      limits:
                        cpu: "?*"
                        memory: "?*"