# kyverno-policies/cis/cis-4.2.1-test.yaml
name: cis-4.2.1-disallow-privileged-containers-test
policies:
  - cis-4.2.1.yaml
resources:
  # Pass case 1: No securityContext defined (defaults are non-privileged)
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-pass-no-context
    spec:
      containers:
      - name: nginx
        image: nginx
  # Pass case 2: securityContext.privileged explicitly false
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-pass-privileged-false
    spec:
      containers:
      - name: nginx
        image: nginx
        securityContext:
          privileged: false # Compliant
  # Pass case 3: Init container privileged false
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-pass-init-privileged-false
    spec:
      initContainers:
      - name: init-myservice
        image: busybox
        securityContext:
          privileged: false # Compliant
      containers:
      - name: nginx
        image: nginx
  # Fail case 1: securityContext.privileged explicitly true in container
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-fail-privileged-true
    spec:
      containers:
      - name: nginx
        image: nginx
        securityContext:
          privileged: true # Non-compliant
  # Fail case 2: securityContext.privileged explicitly true in initContainer
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-fail-init-privileged-true
    spec:
      initContainers:
      - name: init-myservice
        image: busybox
        securityContext:
          privileged: true # Non-compliant
      containers:
      - name: nginx
        image: nginx
results:
  - policy: cis-4.2.1-disallow-privileged-containers
    rule: disallow-privileged-containers
    resource: pod-pass-no-context
    kind: Pod
    result: pass
  - policy: cis-4.2.1-disallow-privileged-containers
    rule: disallow-privileged-containers
    resource: pod-pass-privileged-false
    kind: Pod
    result: pass
  - policy: cis-4.2.1-disallow-privileged-containers
    rule: disallow-privileged-containers
    resource: pod-pass-init-privileged-false
    kind: Pod
    result: pass
  - policy: cis-4.2.1-disallow-privileged-containers
    rule: disallow-privileged-containers
    resource: pod-fail-privileged-true
    kind: Pod
    result: fail # Changed to fail as per policy logic
  - policy: cis-4.2.1-disallow-privileged-containers
    rule: disallow-privileged-containers
    resource: pod-fail-init-privileged-true
    kind: Pod
    result: fail # Changed to fail as per policy logic