# kyverno-policies/cis/cis-4.5.2.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-4.5.2-disallow-default-namespace
  annotations:
    policies.kyverno.io/title: Disallow Default Namespace
    policies.kyverno.io/category: CIS EKS Benchmarks
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: All Kinds
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/description: >-
      The default namespace should not be used for deploying applications or resources.
      Resources should be organized into specific namespaces. This policy audits
      namespaced resources created in the 'default' namespace.
    policies.kyverno.io/benchmark: cis-eks
    policies.kyverno.io/controls: "4.5.2"
spec:
  validationFailureAction: Audit
  background: false # Check only on create/update
  rules:
    - name: disallow-default-namespace
      match:
        any:
        - resources:
            # Target common namespaced resources. Add more as needed.
            kinds:
              - Pod
              - Deployment
              - StatefulSet
              - DaemonSet
              - Job
              - CronJob
              - Service
              - Ingress
              - ConfigMap
              - Secret
              - PersistentVolumeClaim
              - ServiceAccount
              - Role
              - RoleBinding
              - NetworkPolicy
      validate:
        message: "Using the 'default' namespace is disallowed (CIS 4.5.2)."
        pattern:
          metadata:
            # Ensure the namespace is not 'default'.
            # This works because the admission controller populates the namespace field
            # before Kyverno validation if it's not specified in the request.
            namespace: "!default"