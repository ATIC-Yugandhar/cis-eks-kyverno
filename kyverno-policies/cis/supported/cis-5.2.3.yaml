apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-5.2.3-restrict-apparmor-profiles
  annotations:
    policies.kyverno.io/title: Restrict AppArmor Profiles
    policies.kyverno.io/category: CIS EKS Benchmark Section 5.2
    policies.kyverno.io/severity: low # Often considered low/medium as AppArmor is not enabled everywhere
    policies.kyverno.io/subject: Pod, Annotation
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kyverno-version: 1.7.1
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      AppArmor is a Linux security module that restricts container capabilities. Pods should be configured
      to use the 'runtime/default' or 'localhost/*' AppArmor profiles to enhance security.
      This policy checks that Pods and controllers specify an appropriate AppArmor profile
      via annotations (`container.apparmor.security.beta.kubernetes.io/<container-name>`).
      Note: This policy audits; AppArmor must be enabled and configured on the nodes for profiles to be enforced.
      CIS Benchmark Control: 5.2.3 Ensure that AppArmor profile is set to 'runtime/default' or 'localhost/*' in Pod definitions
    policies.kyverno.io/cis_controls: "5.2.3"
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: check-apparmor-pods
      match:
        any:
        - resources:
            kinds:
              - Pod
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "AppArmor profile must be 'runtime/default' or start with 'localhost/'. Check annotations 'container.apparmor.security.beta.kubernetes.io/<container-name>'. CIS 5.2.3"
        pattern:
          metadata:
            =(annotations):
              "container.apparmor.security.beta.kubernetes.io/*": "runtime/default | localhost/*"
    - name: check-apparmor-controllers
      match:
        any:
        - resources:
            kinds:
              - Deployment
              - StatefulSet
              - DaemonSet
              - Job
              - CronJob
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "AppArmor profile in pod templates must be 'runtime/default' or start with 'localhost/'. Check annotations 'container.apparmor.security.beta.kubernetes.io/<container-name>'. CIS 5.2.3"
        pattern:
          spec:
            template:
              metadata:
                =(annotations):
                  "container.apparmor.security.beta.kubernetes.io/*": "runtime/default | localhost/*"