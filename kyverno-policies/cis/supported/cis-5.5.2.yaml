apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-5.5.2-require-resource-requests
  annotations:
    policies.kyverno.io/title: Require Container Resource Requests
    policies.kyverno.io/category: CIS EKS Benchmark Section 5.5
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod, Container, Resource Requests
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kyverno-version: 1.7.1
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      Resource requests specify the minimum amount of CPU and memory a container needs to run.
      Setting requests helps the Kubernetes scheduler make better placement decisions and ensures
      workloads have the necessary resources allocated. This policy requires all containers
      (including initContainers and ephemeralContainers) to define CPU and memory requests.
      CIS Benchmark Control: 5.5.2 Ensure that container memory and CPU requests are configured
    policies.kyverno.io/cis_controls: "5.5.2"
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-cpu-memory-requests-containers
      match:
        any:
        - resources:
            kinds:
              - Pod
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Containers must have CPU and memory requests defined. CIS 5.5.2"
        pattern:
          spec:
            =(containers):
              - resources:
                  requests:
                    cpu: "?*"
                    memory: "?*"
            =(initContainers):
              - resources:
                  requests:
                    cpu: "?*"
                    memory: "?*"
            =(ephemeralContainers):
              - resources:
                  requests:
                    cpu: "?*"
                    memory: "?*"
    - name: require-cpu-memory-requests-controllers
      match:
        any:
        - resources:
            kinds:
              - Deployment
              - StatefulSet
              - DaemonSet
              - Job
              - CronJob
      exclude:
        any:
        - resources:
            namespaces:
              - kube-system
              - gatekeeper-system
              - kyverno
      validate:
        message: "Containers in pod templates must have CPU and memory requests defined. CIS 5.5.2"
        pattern:
          spec:
            template:
              spec:
                =(containers):
                  - resources:
                      requests:
                        cpu: "?*"
                        memory: "?*"
                =(initContainers):
                  - resources:
                      requests:
                        cpu: "?*"
                        memory: "?*"
                =(ephemeralContainers):
                  - resources:
                      requests:
                        cpu: "?*"
                        memory: "?*"