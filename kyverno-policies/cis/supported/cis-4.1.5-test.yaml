# kyverno-policies/cis/cis-4.1.5-test.yaml
name: cis-4.1.5-disallow-default-serviceaccount-test
policies:
  - cis-4.1.5.yaml
resources:
  # Pass case 1: Explicit non-default service account
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-pass-explicit-sa
    spec:
      serviceAccountName: my-app-sa # Compliant
      containers:
      - name: nginx
        image: nginx
  # Pass case 2: Default service account but token not mounted
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-pass-default-sa-no-mount
    spec:
      serviceAccountName: default # Allowed because token is not mounted
      automountServiceAccountToken: false # Compliant
      containers:
      - name: nginx
        image: nginx
  # Pass case 3: Implicit default service account but token not mounted
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-pass-implicit-sa-no-mount
    spec:
      # serviceAccountName implicitly 'default'
      automountServiceAccountToken: false # Compliant
      containers:
      - name: nginx
        image: nginx
  # Fail case 1: Explicit default service account, token mounted (implicitly)
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-fail-explicit-default-sa
    spec:
      serviceAccountName: default # Non-compliant
      # automountServiceAccountToken implicitly true
      containers:
      - name: nginx
        image: nginx
  # Fail case 2: Implicit default service account, token mounted (implicitly)
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-fail-implicit-default-sa
    spec:
      # serviceAccountName implicitly 'default'
      # automountServiceAccountToken implicitly true
      containers:
      - name: nginx
        image: nginx
results:
  - policy: cis-4.1.5-disallow-default-serviceaccount
    rule: check-default-serviceaccount
    resource: pod-pass-explicit-sa
    kind: Pod
    result: pass
  - policy: cis-4.1.5-disallow-default-serviceaccount
    rule: check-default-serviceaccount
    resource: pod-pass-default-sa-no-mount
    kind: Pod
    result: pass
  - policy: cis-4.1.5-disallow-default-serviceaccount
    rule: check-default-serviceaccount
    resource: pod-pass-implicit-sa-no-mount
    kind: Pod
    result: pass
  - policy: cis-4.1.5-disallow-default-serviceaccount
    rule: check-default-serviceaccount
    resource: pod-fail-explicit-default-sa
    kind: Pod
    result: fail
  - policy: cis-4.1.5-disallow-default-serviceaccount
    rule: check-default-serviceaccount
    resource: pod-fail-implicit-default-sa
    kind: Pod
    result: fail