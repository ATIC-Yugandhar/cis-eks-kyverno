apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-5.1.1-require-pss-labels
  annotations:
    policies.kyverno.io/title: Require Pod Security Standard Labels on Namespaces
    policies.kyverno.io/category: CIS EKS Benchmark Section 5.1
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Namespace
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kyverno-version: 1.7.1
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      Pod Security Standards (PSS) define different levels of security policies for pods.
      Namespaces should be labeled to enforce either the 'baseline' or 'restricted' PSS profile
      to ensure pods adhere to minimum security requirements. This policy checks that namespaces
      (excluding system namespaces) have the 'pod-security.kubernetes.io/enforce' label set
      to 'baseline' or 'restricted'.
      CIS Benchmark Control: 5.1.1 Ensure that the cluster is configured with Pod Security Standards
    policies.kyverno.io/cis_controls: "5.1.1"
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-pss-enforce-label
      match:
        any:
        - resources:
            kinds:
              - Namespace
      exclude:
        any:
        - resources:
            # Exclude system and Kyverno namespaces as they often require privileged operations
            names:
              - kube-system
              - kube-public
              - kube-node-lease
              - kyverno
              - gatekeeper-system # Add other system/management namespaces if necessary
      validate:
        message: "Namespace must have 'pod-security.kubernetes.io/enforce' label set to 'baseline' or 'restricted'. CIS 5.1.1"
        pattern:
          metadata:
            labels:
              pod-security.kubernetes.io/enforce: "baseline | restricted"