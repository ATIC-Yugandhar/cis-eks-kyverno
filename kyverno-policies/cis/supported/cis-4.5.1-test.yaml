# kyverno-policies/cis/cis-4.5.1-test.yaml
name: cis-4.5.1-validate-resource-namespace-test
policies:
  - cis-4.5.1.yaml
resources:
  # Pass case: Pod in a specific namespace
  - apiVersion: v1
    kind: Pod
    metadata:
      name: pod-in-app-ns
      namespace: app-ns # Compliant
    spec:
      containers:
      - name: nginx
        image: nginx
  # Fail case 1: Deployment explicitly in 'default' namespace
  - apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: deployment-in-default
      namespace: default # Non-compliant
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: nginx
      template:
        metadata:
          labels:
            app: nginx
        spec:
          containers:
          - name: nginx
            image: nginx
  # Fail case 2: Service without namespace (will likely default to 'default' by API server)
  # Although the API server might add 'default', the policy checks against '!default', so it should fail.
  - apiVersion: v1
    kind: Service
    metadata:
      name: service-no-ns
      # namespace: default # Implicitly default, Non-compliant
    spec:
      selector:
        app: MyApp
      ports:
        - protocol: TCP
          port: 80
          targetPort: 9376
  # Resource not matched by policy (ClusterRole) - should be skipped
  - apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRole
    metadata:
      name: cluster-reader
    rules:
    - apiGroups: [""]
      resources: ["pods"]
      verbs: ["get", "watch", "list"]
results:
  - policy: cis-4.5.1-validate-resource-namespace
    rule: validate-resource-has-namespace
    resource: pod-in-app-ns
    kind: Pod
    result: pass
  - policy: cis-4.5.1-validate-resource-namespace
    rule: validate-resource-has-namespace
    resource: deployment-in-default
    kind: Deployment
    result: fail
  - policy: cis-4.5.1-validate-resource-namespace
    rule: validate-resource-has-namespace
    resource: service-no-ns
    kind: Service
    # Assuming API server adds 'default' namespace before Kyverno validation
    result: fail
  # ClusterRole is not matched by the policy rule, so no result entry is needed for it.
  # If background=true, it might show as 'skip', but with background=false, it's just not processed.