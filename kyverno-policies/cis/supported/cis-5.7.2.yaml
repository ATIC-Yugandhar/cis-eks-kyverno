apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-5.7.2-restrict-default-namespace
  annotations:
    policies.kyverno.io/title: Restrict Default Namespace Usage
    policies.kyverno.io/category: CIS EKS Benchmark Section 5.7
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod, Deployment, StatefulSet, DaemonSet, Job, CronJob, Service, ConfigMap, Secret, ServiceAccount, RoleBinding, ClusterRoleBinding # Add more kinds as needed
    policies.kyverno.io/minversion: 1.6.0
    kyverno.io/kyverno-version: 1.7.1
    kyverno.io/kubernetes-version: "1.23"
    policies.kyverno.io/description: >-
      The default namespace should not be used for application workloads. Using specific namespaces
      provides better administrative boundaries, resource quota management, and network policy application.
      This policy restricts the creation of common workload and configuration resources in the 'default' namespace.
      CIS Benchmark Control: 5.7.2 Ensure that the default namespace is not used
    policies.kyverno.io/cis_controls: "5.7.2"
spec:
  validationFailureAction: Audit # Start with Audit, can be changed to Enforce later
  background: true
  rules:
    - name: restrict-default-namespace
      match:
        any:
        - resources:
            kinds:
              # Common workload/config resources. Add/remove kinds based on requirements.
              - Pod
              - Deployment
              - StatefulSet
              - DaemonSet
              - Job
              - CronJob
              - Service
              - ConfigMap
              - Secret
              - ServiceAccount
              - RoleBinding
              # ClusterRoleBindings are cluster-scoped but often bind to subjects in 'default'
              # - ClusterRoleBinding # Consider if needed; matching subjects is more complex
            namespaces:
              - default
      # Exclude resources managed by Kubernetes itself if necessary, though typically few in 'default'
      # exclude:
      #   resources:
      #     names:
      #       - kubernetes # Default service in 'default' namespace
      validate:
        message: "Creation of resources in the 'default' namespace is restricted. Please use a dedicated namespace. CIS 5.7.2"
        deny: {} # Simple deny rule - if the resource matches, it's denied (or audited)