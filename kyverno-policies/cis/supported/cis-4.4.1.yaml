# kyverno-policies/cis/cis-4.4.1.yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: cis-4.4.1-disallow-secrets-as-env
  annotations:
    policies.kyverno.io/title: Disallow Secrets as Environment Variables
    policies.kyverno.io/category: CIS EKS Benchmarks
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/minversion: 1.6.0
    policies.kyverno.io/description: >-
      Secrets mounted as environment variables can be exposed accidentally through logs or inspection.
      It is recommended to mount secrets as files in volumes instead. This policy validates
      that Pods do not mount secrets as environment variables using `env` or `envFrom`.
    policies.kyverno.io/benchmark: cis-eks
    policies.kyverno.io/controls: "4.4.1"
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: disallow-secrets-as-env-vars
      match:
        any:
        - resources:
            kinds:
              - Pod
      validate:
        message: "Secrets should be mounted as files, not environment variables (CIS 4.4.1)."
        pattern:
          spec:
            containers:
            - =(env): # Check env array if it exists
                - =(valueFrom): # Check valueFrom if it exists
                    =(secretKeyRef): null # Ensure secretKeyRef is not present (null)
              =(envFrom): # Check envFrom array if it exists
                - =(secretRef): null # Ensure secretRef is not present (null)
            =(initContainers): # Also check initContainers if they exist
            - =(env):
                - =(valueFrom):
                    =(secretKeyRef): null
              =(envFrom):
                - =(secretRef): null
            =(ephemeralContainers): # Also check ephemeralContainers if they exist
            - =(env):
                - =(valueFrom):
                    =(secretKeyRef): null
              =(envFrom):
                - =(secretRef): null